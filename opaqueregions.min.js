function opaqueregions(a,x,y,b,c){var d,context,pixels,boxes=[],collisions=[];if(a instanceof ImageData){d={width:a.width,height:a.height};pixels=a}else{d=(a instanceof CanvasRenderingContext2D?a.canvas:a);context=(a instanceof CanvasRenderingContext2D?a:d.getContext('2d'));pixels=context.getImageData(x?x:0,y?y:0,b?b:d.width,c?c:d.height)}for(var i=0;i<pixels.data.length;i+=4){var y=Math.floor((i/4)/d.width),x=Math.floor((i-((y*d.width)*4))/4);if(pixels.data[i+3]!=0){if((x==0||pixels.data[i-1]==0)&&(y==0||pixels.data[(i-(d.width*4))+3]==0)){boxes.push({top:y,right:null,bottom:null,left:x})}}}for(var i in boxes){var e=null,bottom=null;for(var y=boxes[i].top;y<d.height;y++){for(var x=boxes[i].left;x<d.width;x++){if(x>0&&(pixels.data[(((y*d.width)+x)*4)+3]==0||x==(d.width-1))&&e===null){e=(x==(d.width-1))?x+1:x}}if(y>0&&(pixels.data[(((y*d.width)+boxes[i].left)*4)+3]==0||y==(d.height-1))&&bottom===null){bottom=(y==(d.height-1))?y+1:y}}boxes[i].right=e;boxes[i].bottom=bottom}for(var i in boxes){for(var j in boxes){if(j!=i&&boxes[j].left<boxes[i].left+(boxes[i].right-boxes[i].left)&&boxes[j].left+(boxes[j].right-boxes[j].left)>boxes[i].left&&boxes[j].top<boxes[i].top+(boxes[i].bottom-boxes[i].top)&&(boxes[j].bottom-boxes[j].top)+boxes[j].top>boxes[i].left){var f=[i,j];f.sort();f=f.join(',');if(collisions.indexOf(f)==-1){collisions.push(f)}}}}for(var i in collisions){var f=collisions[i].split(','),mintop=d.height,maxright=0,maxbottom=0,minleft=d.width;for(var j in f){if(boxes[f[j]].top<mintop){mintop=boxes[f[j]].top}if(boxes[f[j]].right>maxright){maxright=boxes[f[j]].right}if(boxes[f[j]].bottom>maxbottom){maxbottom=boxes[f[j]].bottom}if(boxes[f[j]].left<minleft){minleft=boxes[f[j]].left}delete boxes[f[j]]}boxes.push({top:mintop,right:maxright,bottom:maxbottom,left:minleft})}return boxes}
